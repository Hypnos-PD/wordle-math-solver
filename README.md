# Wordle 数学等式筛选器

一个纯前端的 Wordle 风格数学等式候选筛选工具，支持单式与 4 式并行模式，并提供**12*4图片识别导入**功能。

## 功能特点

- ✅ 纯前端实现，零依赖，可离线使用
- ✅ 支持单式和 4 式并行模式
- ✅ **图片识别导入**（自动识别12*4游戏截图）
- ✅ **历史记录可编辑**（文本和颜色均可修改）
- ✅ **冲突检测**（自动标红矛盾的绿色位置）
- ✅ 智能约束构建和 DFS 候选生成
- ✅ 颜色循环标记（灰→黄→绿，支持右键逆序）
- ✅ 约束一致性检查（防止添加矛盾的反馈）
- ✅ 猜测历史管理（可编辑、删除）
- ✅ 导入/导出状态（JSON 格式）
- ✅ 键盘输入、粘贴支持
- ✅ 可配置长度（5-20）、超时、最大结果数

## 快速开始

直接在浏览器中打开 `index.html` 即可使用，无需任何构建步骤。

```bash
# Windows
start index.html

# macOS
open index.html

# Linux
xdg-open index.html
```

## 使用说明

### 基本流程

1. **设置参数**：调整等式长度（默认 12）、最大结果数（默认 200）、超时时间（默认 2000ms）
2. **输入猜测**：在网格中输入等式字符（支持键盘输入或粘贴）
3. **标记颜色**：
   - 左键点击：灰 → 黄 → 绿 → 灰
   - 右键点击：绿 → 黄 → 灰 → 绿
4. **添加猜测**：点击"添加当前猜测"保存到历史（会自动检查约束一致性）
5. **管理历史**：可以删除最新猜测或清空全部历史
6. **搜索候选**：点击"开始搜索候选"生成可能的等式

### 颜色语义

- 🟩 **绿色**：字符在该位置正确
- 🟨 **黄色**：字符存在但位置错误
- ⬜ **灰色**：字符不存在，或出现次数已达上限

### 4 式模式

1. 勾选"4 式模式"复选框
2. 在主输入区输入字符
3. 在下方 4 行颜色格分别标记各目标的反馈
4. 添加猜测时会检查约束一致性
5. 搜索时会为每个目标独立生成候选
6. 猜测历史显示为两行（目标1+2，目标3+4）

### 🖼️ 图片识别导入（新功能）

**支持从 12*4 Wordle Math 游戏截图自动识别猜测历史！**

#### 使用方法

1. **从文件导入**：
   - 点击 "🖼️ 从图片识别" 按钮
   - 选择游戏截图文件（PNG/JPG）

2. **从剪贴板导入**：
   - 在游戏中按 `Ctrl+C` 或右键复制截图
   - 点击 "📋 从剪贴板识别" 按钮
   - 允许浏览器访问剪贴板

#### 支持的图片格式

- **布局**：2×2 网格（4个目标区域），推荐分辨率 800×950 或更高
- **每个区域**：12 列 × 最多 9 行
- **颜色识别**：自动检测绿色/黄色/灰色格子

#### 识别过程

1. **颜色网格提取**（0-30%）
   - 自动分割 2×2 布局
   - 多点采样检测每个格子颜色
   - 过滤空白行
   
2. **OCR 文字识别**（30-90%）
   - 使用 Tesseract.js 识别等式
   - 字符白名单：`0-9+-*/=`
   - 图像预处理（灰度化、二值化、膨胀）
   
3. **数据解析**（90-100%）
   - 滑动窗口提取 12 位等式
   - 验证等式合法性（计算检查）
   - 自动匹配颜色模式

#### 识别准确率

- **颜色识别**：~95-100%
- **文字识别**：~80-100%（取决于截图质量）
- **失败处理**：缺失的行会用 `????????????` 占位，可手动编辑

#### 故障排除

1. **识别失败**：
   - 确保图片清晰、对比度足够
   - 检查是否为标准 2×2 布局
   - 查看浏览器控制台（F12）的详细日志

2. **OCR 错误**：
   - 所有历史记录都可以手动编辑（见下文）
   - 点击等式文本直接修改
   - 点击颜色格子切换颜色

3. **剪贴板无权限**：
   - 浏览器会弹出权限请求，点击"允许"
   - 或使用文件导入方式

### ✏️ 编辑历史记录（新功能）

**所有已添加的历史记录都可以编辑！**

#### 编辑等式文本

- 点击历史记录中的等式文本即可编辑
- 自动过滤非法字符（只保留 `0-9+-*/=`）
- 长度限制为当前设定长度
- 失焦时自动保存并重新检测冲突

#### 编辑颜色格子

- **左键点击**：灰 → 黄 → 绿 → 灰
- **右键点击**：灰 → 绿 → 黄 → 灰（逆序）
- 点击后立即生效并重新检测冲突

#### 删除记录

- 点击每条历史右侧的 **×** 按钮删除该记录

### 🔍 冲突检测（新功能）

系统会自动检测历史记录中的逻辑冲突：

- **检测规则**：同一目标的不同猜测中，绿色位置的字符必须一致
- **标记方式**：冲突的记录会显示红色边框和浅红背景
- **提示信息**：悬停在冲突记录上会显示详细原因

**示例冲突**：
- 记录1：位置3是绿色 `5` → `??5?????=??`
- 记录2：位置3是绿色 `7` → `??7?????=??`
- 系统会将这两条记录标红

### 等式规则

- 允许字符：`0-9 + - * / =`
- 必须恰好有一个 `=`，且不在首末
- 右侧只能是纯数字或负数（如 `-9`）
- 左右侧不能以 `*` 或 `/` 开头
- 等式两侧求值必须相等

## 示例

### 示例 1：单式模式 + 约束检查

假设目标等式是 `2+3-1*4=0`

1. 第一次猜测：`1+2-3*4=-5`
   - 标记颜色：根据反馈标记每个位置
   - 点击"添加当前猜测"
2. 第二次猜测：尝试输入矛盾的反馈
   - 系统会提示"约束冲突"并阻止添加
3. 输入正确的反馈后继续猜测
4. 搜索候选，查看可能的等式

### 示例 2：4 式模式 + 历史管理

当同一猜测对应 4 个不同目标时：

1. 在主输入输入：`2+-2+1-10=-9`
2. 在 4 行颜色格分别标记各自的反馈
3. 添加猜测（历史会分两行显示）
4. 如果发现标记错误，可点击"删除最新猜测"
5. 搜索时会为每个目标生成独立的候选列表

## 导入/导出

### 导出

点击"📤 导出状态"会：
- 将状态复制到剪贴板
- 自动下载 JSON 文件

### 导入

点击"📥 导入状态"，粘贴之前导出的 JSON 数据，即可恢复现场。

JSON 格式示例：
```json
{
  "version": 1,
  "length": 12,
  "mode4": false,
  "currentInput": "2+3-1*4=0",
  "currentStates": "xxggyyxxggxx",
  "colorGrids": null,
  "guesses": [
    {
      "guess": "1+2-3*4=-5",
      "patterns": "xygxxgxxxgyx",
      "is4Mode": false
    }
  ]
}
```

## 技术实现

### 文件结构

```
wordle-math-solver/
├── index.html      # 主页面
├── style.css       # 样式
├── solver.js       # 求解核心（约束构建、DFS、验证）
├── app.js          # UI 交互逻辑
├── image-ocr.js    # 图片识别模块（颜色检测 + OCR）
└── README.md       # 本文档
```

### 图片识别

- **OCR 引擎**：Tesseract.js v5.0.0（从 jsDelivr CDN 加载）
- **颜色检测**：RGB 阈值 + 特征检测（G>R+10 判断绿色，R-B>80 判断黄色）
- **采样策略**：3×3 多点投票（每格 9 个采样点，取票数最高颜色）
- **图像预处理**：
  - 灰度化
  - Otsu 阈值二值化
  - 形态学膨胀（3px 半径）
  - 选择性反转（白色文字 → 黑色）
- **文本提取**：滑动窗口 + 计算验证（`Function('return ' + leftSide)() === parseInt(rightSide)`）

### 核心算法

#### 约束对象

```javascript
{
  greens: Array(length),               // 固定字符或 null
  requiredCounts: {ch: n},             // ch 至少出现次数 (g+y)
  maxCounts: {ch: n},                  // 上限
  excluded: Set(),                     // 完全排除的字符
  yellowForbiddenPositions: {ch: Set(indices)} // 禁止位置
}
```

#### DFS 生成

- 按位置递归扩展
- 实时剪枝（次数限制、位置禁止、剩余可行性）
- 完成时验证等式合法性
- 按评分排序（鼓励字符多样性）

#### 评分公式

```javascript
score = uniqueChars * 1.5 - operatorCount
```

## 性能指标

- **搜索速度**：默认 2 秒超时内返回 ≤200 条候选
- **图片识别速度**：约 3-5 秒（取决于 OCR 引擎初始化）
- **颜色识别准确率**：95-100%
- **文字识别准确率**：80-100%（清晰截图可达 100%）
- **支持的图片尺寸**：800×950 或等比缩放
- **支持实时取消**：搜索和 OCR 过程均可中断

## 兼容性

- 现代桌面浏览器（Chrome 90+、Edge 90+、Firefox 88+、Safari 14+）
- 需要支持 ES6+ 语法
- 图片识别功能需要：
  - Canvas API
  - FileReader API
  - Clipboard API（剪贴板导入）
  - Web Workers（Tesseract OCR）
- 无需服务器，完全客户端运行

## 开发

本项目遵循以下约定

- 纯前端，零依赖，无构建链
- UI 层与求解层分离
- 严格输入验证
- 导出 JSON 向后兼容

## 许可证

MIT License

## 作者

HypnosPD
